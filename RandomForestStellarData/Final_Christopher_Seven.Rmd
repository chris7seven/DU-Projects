---
title: "Final Project Random Forest"
output:
  word_document: default
  html_document: default
---

###########################################################
# This file conducts a random forest analysis on
# astronomical star data to predict spectral type.
###########################################################

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(openxlsx)
library(dplyr)
library(lubridate)
library(ggplot2)
library(randomForest)
library(caTools)
library(caret)
library(pROC)
library(knitr)
```

######################################################################################
# Loading in the data, cleaning it, and converting colum types to their correct value.
######################################################################################
```{r}
totaldata<-read.csv("star_data.csv", na.strings=c("","NA"))
totaldata<-totaldata[4:14]

totaldata<-totaldata %>% 
  rename(
    Right.Ascension = RAJ2000,
    Declination = DEJ2000,
    Heliocentric.Distance = Dist,
    Galactic.Distance = X,
    Spectral.Type = SpType,
    Temperature.Class = Tc,
    Luminosity.Class = Lc,
    Iron = X.Fe.H.,
    Age = age,
    BV.Color = B.V,
    Luminosity = Lum
    )


totaldata$Spectral.Type<-substr(totaldata$Spectral.Type, start = 1, stop = 1)

totaldata$Iron<-as.numeric(totaldata$Iron)
totaldata$Right.Ascension<-as.numeric(totaldata$Right.Ascension)

completedata<-totaldata[complete.cases(totaldata),]

cleandat = filter(completedata, Spectral.Type != "" & Spectral.Type != "-" & Spectral.Type != "B" & Luminosity.Class != "55" & Luminosity.Class != "6" & Luminosity.Class != "1")

cleandat$Spectral.Type<-as.factor(cleandat$Spectral.Type)
cleandat$Luminosity.Class<-as.factor(cleandat$Luminosity.Class)
cleandat$Temperature.Class<-as.factor(cleandat$Temperature.Class)
```

###################################################################
# Separating into test and train data.
###################################################################
```{r}
set.seed(123)

freq2<-nrow(cleandat[cleandat$Luminosity.Class == "2",])/nrow(cleandat[cleandat$Luminosity.Class,])
freq3<-nrow(cleandat[cleandat$Luminosity.Class == "3",])/nrow(cleandat[cleandat$Luminosity.Class,])
freq4<-nrow(cleandat[cleandat$Luminosity.Class == "4",])/nrow(cleandat[cleandat$Luminosity.Class,])
freq5<-nrow(cleandat[cleandat$Luminosity.Class == "5",])/nrow(cleandat[cleandat$Luminosity.Class,])

freqdat<-data.frame(
  Luminosity.Class = c("2", "3", "4", "5"),
  Frequency = c(freq2, freq3, freq4, freq5)
)
ggplot(freqdat, aes(x = Luminosity.Class, y = Frequency)) + geom_bar(stat="Identity")+ ggtitle("Distribution of Luminosity Class")

sample = sample.split(cleandat$Luminosity.Class, SplitRatio = .75)

train.dat = subset(cleandat, sample == TRUE)

test.dat  = subset(cleandat, sample == FALSE)

plot(x=train.dat$Temperature.Class, y=train.dat$Luminosity, xlab="Temperature Class", ylab = "Luminosity", main = "Temperature Class vs. Luminosity")
```
###################################################################
# Running the random forest model and plotting the error rate.
###################################################################
```{r}
rfmodel<- randomForest(Luminosity.Class ~ ., data=train.dat, proximity = TRUE)

oob.error.data<-data.frame(
  Trees = rep(1:nrow(rfmodel$err.rate), times=5),
  Type=rep(c("OOB", "2", "3", "4", "5"), each = 500),
  Error = c(rfmodel$err.rate[, "OOB"],
            rfmodel$err.rate[, "2"],
            rfmodel$err.rate[, "3"],
            rfmodel$err.rate[, "4"],
            rfmodel$err.rate[, "5"]))

ggplot(data = oob.error.data, aes(x=Trees, y=Error)) + geom_line(aes(color=Type))
```


################################################################################
# Calculating the error for different number of variables, and picking the best.
################################################################################
```{r}
oob.values<-vector(length=10)
for(i in 1:10){
  temp.rfmodel<-randomForest(Luminosity.Class ~ ., data=train.dat, mtry=i, ntree = 500)
  oob.values[i] <- temp.rfmodel$err.rate[nrow(temp.rfmodel$err.rate),1]
}
  
best.rfmodel<-randomForest(Luminosity.Class ~ ., data=train.dat, mtry = 2, ntree = 500)

best.oob.error.data<-data.frame(
  Trees = rep(1:nrow(rfmodel$err.rate), times=5),
  Type=rep(c("OOB", "2", "3", "4", "5"), each = 500),
  Error = c(rfmodel$err.rate[, "OOB"],
            rfmodel$err.rate[, "2"],
            rfmodel$err.rate[, "3"],
            rfmodel$err.rate[, "4"],
            rfmodel$err.rate[, "5"]))

ggplot(data = best.oob.error.data, aes(x=Trees, y=Error)) + geom_line(aes(color=Type)) + ggtitle("Error Rate by Luminosity Class")
```
################################################################################
# Analysis on the test data set.
################################################################################
```{r}
pred = predict(best.rfmodel, newdata=test.dat)
confusionMatrix(pred, test.dat$Luminosity.Class)
```

################################################################################
# Calculating area under ROC curves.
################################################################################
```{r}
rocpred = predict(best.rfmodel, newdata=test.dat, type="prob")
multiclass.roc(test.dat$Luminosity.Class, rocpred)
```

```{r appendix, echo=TRUE, eval=FALSE, ref.label=all_labels()}

```